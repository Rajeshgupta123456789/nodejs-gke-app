build:
  image: google/cloud-sdk:latest
  services:
    - docker:24.0.2-dind
  stage: build
  before_script:
    - echo "ğŸ” Writing GCP key..."
    - echo "$GCP_SERVICE_KEY" > key.json
    - echo "ğŸ”‘ Authenticating with gcloud..."
    - gcloud auth activate-service-account --key-file=key.json
    - echo "âœ… Authenticated. Setting project..."
    - gcloud config set project $PROJECT_ID
    - echo "ğŸŒ Setting region..."
    - gcloud config set compute/region $CLUSTER_ZONE
    - echo "ğŸ”— Getting cluster credentials..."
    - gcloud container clusters get-credentials $CLUSTER_NAME --region $CLUSTER_ZONE
    - echo "ğŸ› ï¸  Configuring Docker auth..."
    - gcloud auth configure-docker
  script:
    - docker info
    - docker build -t $IMAGE .
    - docker push $IMAGE
