image: google/cloud-sdk:latest

variables:
  PROJECT_ID: "gkewithgitlabs"
  CLUSTER_NAME: "nodejs-cluster"
  CLUSTER_ZONE: "us-central1-a"
  IMAGE: "gcr.io/$PROJECT_ID/nodejs-gke-app"

stages:
  - build
  - deploy

before_script:
  - echo "$GCP_SERVICE_KEY" > key.json
  - gcloud auth activate-service-account --key-file=key.json
  - gcloud config set project $PROJECT_ID
  - gcloud config set compute/zone $CLUSTER_ZONE
  - gcloud container clusters get-credentials $CLUSTER_NAME

build:
  stage: build
  script:
    - gcloud auth configure-docker
    - docker build -t $IMAGE .
    - docker push $IMAGE

deploy:
  stage: deploy
  script:
    - kubectl apply -f k8s/
