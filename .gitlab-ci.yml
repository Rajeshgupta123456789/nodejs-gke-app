image: docker:24.0.2

services:
  - docker:24.0.2-dind

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_TLS_CERTDIR: ""

stages:
  - build
  - deploy

before_script:
  - docker info
  - echo "$GCP_SERVICE_KEY" > key.json
  - gcloud auth activate-service-account --key-file=key.json
  - gcloud config set project $PROJECT_ID
  - gcloud config set compute/region $CLUSTER_ZONE
  - gcloud container clusters get-credentials $CLUSTER_NAME --region $CLUSTER_ZONE

build:
  stage: build
  script:
    - docker build -t $IMAGE .
    - echo $GCP_SERVICE_KEY | docker login -u _json_key --password-stdin https://gcr.io
    - docker push $IMAGE

deploy:
  stage: deploy
  image:
    name: google/cloud-sdk:latest
    entrypoint: [""]
  script:
    - kubectl apply -f k8s/
